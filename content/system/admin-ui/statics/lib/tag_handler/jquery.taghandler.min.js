(function(b){function l(b,a){var e=!1;jQuery.each(a,function(a,f){if(f===b)return e=!0,!1});return e}function m(b,a){jQuery.each(a,function(e,g){g===b&&a.splice(e,1)});return a}function n(d,a,e,g){e.assignedTags.push(a);e.availableTags=m(a,e.availableTags);b("<li />").addClass("tagItem").text(a).insertBefore(b(d).parent());g&&(e=j(e));return e}function q(d,a,e){var g=b(d).text();a.assignedTags=m(g,a.assignedTags);l(g,a.originalTags)&&a.availableTags.push(g);b(d).remove();e&&(a=j(a));return a}function j(b){b.availableTags=
b.availableTags.sort();b.assignedTags=b.assignedTags.sort();b.originalTags=b.originalTags.sort();return b}function k(d,a,e){d={tags:d.assignedTags};b.extend(d,a.updateData);b.ajax({type:"POST",url:a.updateURL,cache:!1,data:d,dataType:"json",beforeSend:function(){b("#"+e+"_save").length?b("#"+e+"_save").fadeOut(200,function(){b("#"+e+"_loader").fadeIn(200)}):b("#"+e+"_loader").fadeIn(200)},complete:function(){b("#"+e+"_loader").fadeOut(200,function(){b("#"+e+"_save").length&&b("#"+e+"_save").fadeIn(200)})}})}
function p(d,a,e,g){b(a.assignedTags).each(function(f,c){d.allowEdit?b("<li />").addClass("tagItem").text(c).insertBefore(b(e).parent()):b("<li />").addClass("tagItem").css("cursor","default").text(c).appendTo(b(g));a.availableTags=m(c,a.availableTags)});return a}function r(d,a){a.debug&&(window.console&&window.console.log)&&(window.console.log(d),window.console.log(a),window.console.log(b.fn.tagHandler.defaults))}var s={getSerializedTags:function(){var d=[];b(this).find("li.tagItem").each(function(a,
e){d.push(b(e).text())});return d.join(",")},getTags:function(){var d=[];b(this).find("li.tagItem").each(function(a,e){d.push(b(e).text())});return d},version:function(){return"1.3.0"}};b.fn.tagHandler=function(d){if("object"==typeof d||"undefined"==typeof d){var a=b.extend({},b.fn.tagHandler.defaults,d);r(b(this),a);return this.each(function(){if(!b(this).is("ul"))return!0;var e=this,d=b(e);e.id||(e.id=(new Date).getTime());d.wrap('<div class="'+a.className+'" />');d.addClass(a.className+"Container");
a.allowEdit&&d.html('<li class="tagInput"><input class="tagInputField" type="text" /></li>');var f=d.find(".tagInputField"),c=[];c.availableTags=[];c.originalTags=[];c.assignedTags=[];""!==a.updateURL&&(a.autoUpdate||b("<div />").attr({id:e.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){k(c,a,e.id)}).appendTo(d.parent()),b("<div />").attr({id:e.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(d.parent()));a.autocomplete&&"function"==typeof b.fn.autocomplete&&
a.initLoad?b(f).autocomplete({source:c.availableTags,select:function(d,h){var t=b(this);if(!l(b.trim(h.item.value),c.assignedTags)){if(0<a.maxTags&&c.assignedTags.length>=a.maxTags)alert("Maximum tags allowed: "+a.maxTags);else{var g=b.trim(h.item.value),j=1;"function"==typeof a.onAdd&&(j=a.onAdd.call(this,g));if(j||"undefined"==typeof j)c=n(this,g,c,a.sortTags),""!==a.updateURL&&a.autoUpdate&&k(c,a,e.id),b(f).autocomplete("option","source",c.availableTags),"function"==typeof a.afterAdd&&a.afterAdd.call(this,
g)}t.focus()}t.val("");return!1},minLength:a.minChars}):a.autocomplete&&"function"==typeof b.fn.autocomplete&&b(f).autocomplete({source:function(c,e){a.getData[a.queryname]=c.term;b.getJSON(a.getURL,a.getData,function(a){e(a.availableTags)})},select:function(d,h){var f=b(this);if(!l(b.trim(h.item.value),c.assignedTags)){if(0<a.maxTags&&c.assignedTags.length>=a.maxTags)alert("Maximum tags allowed: "+a.maxTags);else{var g=b.trim(h.item.value);"function"==typeof a.onAdd&&a.onAdd.call(this,g);c=n(this,
b.trim(h.item.value),c,a.sortTags);""!==a.updateURL&&a.autoUpdate&&k(c,a,e.id);"function"==typeof a.afterAdd&&a.afterAdd.call(this,g)}f.focus()}f.val("");return!1},minLength:a.minChars});""!==a.getURL&&a.initLoad?b.ajax({url:a.getURL,cache:!1,data:a.getData,dataType:"json",success:function(d){d.availableTags.length&&(c.availableTags=d.availableTags.slice(),c.originalTags=c.availableTags.slice());a.sortTags&&(c=j(c));d.assignedTags.length&&(c.assignedTags=d.assignedTags.slice(),a.sortTags&&(c=j(c)),
c=p(a,c,f,e));a.autocomplete&&("function"==typeof b.fn.autocomplete&&a.allowEdit)&&b(f).autocomplete("option","source",c.availableTags)},error:function(b,c,d){r(b,c,d);alert(a.msgError)}}):""!==a.getURL?(c.assignedTags=a.assignedTags.slice(),a.sortTags&&(c=j(c)),c=p(a,c,f,e)):(a.availableTags.length&&(c.availableTags=a.availableTags.slice(),c.originalTags=c.availableTags.slice()),a.sortTags&&(c=j(c)),a.assignedTags.length&&(c.assignedTags=a.assignedTags.slice(),a.sortTags&&(c=j(c)),c=p(a,c,f,e)),
a.autocomplete&&("function"==typeof b.fn.autocomplete&&a.allowEdit&&a.initLoad)&&b(f).autocomplete("option","source",c.availableTags));a.allowEdit&&(d.delegate("li.tagItem","click",function(){var d=b(this),h=1;"function"==typeof a.onDelete&&(h=a.onDelete.call(this,b.trim(d.text())));h&&(c=q(d,c,a.sortTags),""!==a.updateURL&&a.autoUpdate&&k(c,a,e.id));"function"==typeof a.afterDelete&&a.afterDelete.call(this,b.trim(d.text()));a.autocomplete&&("function"==typeof b.fn.autocomplete&&a.initLoad)&&b(f).autocomplete("option",
"source",c.availableTags)}),b(f).keypress(function(d){var h=b(this);if(13===d.which||44===d.which||d.which===a.delimiter.charCodeAt(0))if(d.preventDefault(),""!==h.val()&&!l(b.trim(h.val()),c.assignedTags))if(!a.allowAdd&&!l(b.trim(h.val()),c.availableTags))alert(a.msgNoNewTag);else{if(0<a.maxTags&&c.assignedTags.length>=a.maxTags)alert("Maximum tags allowed: "+a.maxTags);else{d=b.trim(h.val());var g=1;"function"==typeof a.onAdd&&(g=a.onAdd.call(this,d));if(g||"undefined"==typeof g)c=n(this,d,c,a.sorttags),
""!==a.updateURL&&a.autoUpdate&&k(c,a,e.id),a.autocomplete&&("function"==typeof b.fn.autocomplete&&a.initload)&&b(f).autocomplete("option","source",c.availableTags),"function"==typeof a.afterAdd&&a.afterAdd.call(this,d)}h.val("");h.focus()}}),b(f).keydown(function(j){var h=b(this);8===j.which&&""===h.val()&&(j=d.find(".tagItem:last").text(),"function"==typeof a.onDelete&&a.onDelete.call(this,b.trim(j)),c=q(d.find(".tagItem:last"),c,a.sortTags),""!==a.updateURL&&a.autoUpdate&&k(c,a,e.id),"function"==
typeof a.afterDelete&&a.afterDelete.call(this,b.trim(j)),a.autocomplete&&("function"==typeof b.fn.autocomplete&&a.initLoad)&&b(f).autocomplete("option","source",c.availableTags),h.focus())}),b(f).focus(function(){""===b(f).val()&&(a.autocomplete&&"function"==typeof b.fn.autocomplete&&a.initLoad)&&b(f).autocomplete("search","")}),d.click(function(){b(f).focus()}));this.getTags=function(){return c.assignedTags};return 1})}if("string"==typeof d&&s[d])return s[d].apply(this,Array.prototype.slice.call(arguments,
1))};b.fn.tagHandler.defaults={allowEdit:!0,allowAdd:!0,assignedTags:[],autocomplete:!1,autoUpdate:!1,availableTags:[],className:"tagHandler",debug:!1,delimiter:"",getData:{},getURL:"",initLoad:!0,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},afterAdd:{},afterDelete:{},queryname:"q",sortTags:!0,updateData:{},updateURL:""}})(jQuery);